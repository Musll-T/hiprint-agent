<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HiPrint Agent - 管理面板</title>
  <!-- 预连接 CDN 域名，减少 DNS + TLS 延迟 -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body>
  <div id="app">
    <!-- 侧边栏（Desktop） -->
    <aside class="sidebar" v-if="!isMobile">
      <div class="sidebar-header">
        <h3>HiPrint Agent</h3>
        <small class="text-muted">管理面板</small>
      </div>
      <nav class="sidebar-nav">
        <button
          v-for="tab in tabs"
          :key="tab.key"
          :class="['sidebar-btn', { active: currentTab === tab.key }]"
          @click="currentTab = tab.key"
        >
          <span class="tab-icon">{{ tab.icon }}</span>
          <span>{{ tab.label }}</span>
        </button>
      </nav>
      <div class="sidebar-footer">
        <span class="connection-dot" :class="socketConnected ? 'online' : 'offline'"></span>
        <small>{{ socketConnected ? '已连接' : '未连接' }}</small>
      </div>
    </aside>

    <!-- 主内容区 -->
    <main class="main-content" :class="{ 'with-sidebar': !isMobile }">
      <!-- 顶部标题栏（Mobile） -->
      <header class="mobile-header" v-if="isMobile">
        <h4>HiPrint Agent</h4>
        <span class="connection-dot" :class="socketConnected ? 'online' : 'offline'"></span>
      </header>

      <!-- Dashboard 视图 -->
      <section v-if="currentTab === 'dashboard'" class="view-section">
        <h4 class="view-title">仪表盘</h4>
        <div class="stats-grid">
          <!-- CPU 卡片 -->
          <article class="stat-card">
            <header class="stat-card-header">
              <span class="stat-icon">CPU</span>
            </header>
            <div class="stat-body">
              <p class="stat-value">{{ systemStats.system?.cpuCount || 0 }} 核</p>
              <p class="stat-label">{{ systemStats.system?.cpuModel || '未知' }}</p>
            </div>
          </article>

          <!-- 内存卡片 -->
          <article class="stat-card">
            <header class="stat-card-header">
              <span class="stat-icon">内存</span>
            </header>
            <div class="stat-body">
              <p class="stat-value">{{ formatBytes(systemStats.system?.freeMem) }} 可用</p>
              <p class="stat-label">共 {{ formatBytes(systemStats.system?.totalMem) }}</p>
              <div class="mem-bar">
                <div
                  class="mem-bar-fill"
                  :style="{ width: memUsagePercent + '%' }"
                  :class="memUsageClass"
                ></div>
              </div>
              <small class="text-muted">已使用 {{ memUsagePercent }}%</small>
            </div>
          </article>

          <!-- 活跃任务卡片 -->
          <article class="stat-card">
            <header class="stat-card-header">
              <span class="stat-icon">任务</span>
            </header>
            <div class="stat-body">
              <p class="stat-value">{{ activeJobCount }}</p>
              <p class="stat-label">活跃任务</p>
              <div class="stat-detail">
                <span class="badge badge-rendering">渲染中 {{ systemStats.jobs?.rendering || 0 }}</span>
                <span class="badge badge-printing">打印中 {{ systemStats.jobs?.printing || 0 }}</span>
              </div>
            </div>
          </article>

          <!-- 运行时间卡片 -->
          <article class="stat-card">
            <header class="stat-card-header">
              <span class="stat-icon">运行</span>
            </header>
            <div class="stat-body">
              <p class="stat-value">{{ formatUptime(systemStats.system?.uptime) }}</p>
              <p class="stat-label">运行时间</p>
              <div class="stat-detail">
                <small class="text-muted">{{ systemStats.system?.hostname || '--' }}</small>
              </div>
            </div>
          </article>
        </div>

        <!-- 任务统计概览 -->
        <h5 class="section-subtitle">任务统计</h5>
        <div class="stats-grid">
          <article class="stat-card mini">
            <div class="stat-body">
              <p class="stat-value">{{ systemStats.jobs?.received || 0 }}</p>
              <p class="stat-label">已接收</p>
            </div>
          </article>
          <article class="stat-card mini">
            <div class="stat-body">
              <p class="stat-value text-green">{{ systemStats.jobs?.done || 0 }}</p>
              <p class="stat-label">已完成</p>
            </div>
          </article>
          <article class="stat-card mini">
            <div class="stat-body">
              <p class="stat-value text-red">{{ systemStats.jobs?.failed || 0 }}</p>
              <p class="stat-label">失败</p>
            </div>
          </article>
          <article class="stat-card mini">
            <div class="stat-body">
              <p class="stat-value">{{ systemStats.connections || 0 }}</p>
              <p class="stat-label">连接数</p>
            </div>
          </article>
        </div>
      </section>

      <!-- Printers 视图 -->
      <section v-if="currentTab === 'printers'" class="view-section">
        <h4 class="view-title">打印机</h4>
        <div class="printer-grid" v-if="printers.length > 0">
          <article
            v-for="p in printers"
            :key="p.name"
            class="printer-card"
            :class="{ 'printer-offline': p.status > 0 }"
          >
            <div class="printer-status-dot" :class="printerStatusClass(p.status)"></div>
            <div class="printer-info">
              <h6 class="printer-name">{{ p.displayName || p.name }}</h6>
              <small class="text-muted">{{ p.description || '无描述' }}</small>
            </div>
            <div class="printer-badges">
              <span v-if="p.isDefault" class="badge badge-default">默认</span>
              <span class="badge" :class="printerBadgeClass(p.status)">{{ printerStatusText(p.status) }}</span>
            </div>
          </article>
        </div>
        <p v-else class="empty-state">暂未检测到打印机</p>
      </section>

      <!-- Jobs 视图 -->
      <section v-if="currentTab === 'jobs'" class="view-section">
        <h4 class="view-title">任务列表</h4>

        <!-- 状态过滤 -->
        <div class="job-filters">
          <button
            v-for="f in jobFilters"
            :key="f.value"
            :class="['filter-btn', { active: jobFilter === f.value }]"
            @click="jobFilter = f.value; loadJobs()"
          >{{ f.label }}</button>
        </div>

        <!-- Desktop 表格 -->
        <div class="job-table-wrap" v-if="!isMobile && jobs.length > 0">
          <table class="job-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>模板</th>
                <th>打印机</th>
                <th>状态</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="job in jobs" :key="job.id">
                <td><code>{{ shortId(job.id) }}</code></td>
                <td>{{ job.templateId || '--' }}</td>
                <td>{{ job.printer || '--' }}</td>
                <td><span class="badge" :class="jobBadgeClass(job.status)">{{ jobStatusText(job.status) }}</span></td>
                <td>{{ formatTime(job.createdAt) }}</td>
                <td class="job-actions">
                  <button
                    v-if="canCancel(job.status)"
                    class="btn-sm btn-cancel"
                    @click="cancelJob(job.id)"
                  >取消</button>
                  <button
                    v-if="canRetry(job.status)"
                    class="btn-sm btn-retry"
                    @click="retryJob(job.id)"
                  >重试</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Mobile 卡片列表 -->
        <div class="job-card-list" v-if="isMobile && jobs.length > 0">
          <article v-for="job in jobs" :key="job.id" class="job-card">
            <div class="job-card-head">
              <code>{{ shortId(job.id) }}</code>
              <span class="badge" :class="jobBadgeClass(job.status)">{{ jobStatusText(job.status) }}</span>
            </div>
            <div class="job-card-body">
              <p><small class="text-muted">模板：</small>{{ job.templateId || '--' }}</p>
              <p><small class="text-muted">打印机：</small>{{ job.printer || '--' }}</p>
              <p><small class="text-muted">时间：</small>{{ formatTime(job.createdAt) }}</p>
            </div>
            <div class="job-card-actions">
              <button
                v-if="canCancel(job.status)"
                class="btn-sm btn-cancel"
                @click="cancelJob(job.id)"
              >取消</button>
              <button
                v-if="canRetry(job.status)"
                class="btn-sm btn-retry"
                @click="retryJob(job.id)"
              >重试</button>
            </div>
          </article>
        </div>

        <p v-if="jobs.length === 0" class="empty-state">暂无任务记录</p>

        <!-- 加载更多 -->
        <div class="load-more" v-if="jobs.length > 0 && hasMoreJobs">
          <button class="btn-sm btn-load-more" @click="loadMoreJobs">加载更多</button>
        </div>
      </section>

      <!-- Logs 视图 -->
      <section v-if="currentTab === 'logs'" class="view-section">
        <h4 class="view-title">日志记录</h4>
        <div class="log-list" v-if="logEntries.length > 0">
          <div v-for="(entry, idx) in logEntries" :key="idx" class="log-entry">
            <span class="log-time">{{ formatTime(entry.time) }}</span>
            <span class="badge badge-sm" :class="jobBadgeClass(entry.status)">{{ jobStatusText(entry.status) }}</span>
            <span class="log-detail">
              任务 <code>{{ shortId(entry.id) }}</code>
              <template v-if="entry.printer"> - {{ entry.printer }}</template>
            </span>
          </div>
        </div>
        <p v-else class="empty-state">暂无日志</p>
      </section>

      <!-- 底部留白（Mobile 为底部导航栏腾出空间） -->
      <div class="bottom-spacer" v-if="isMobile"></div>
    </main>

    <!-- 底部导航（Mobile） -->
    <nav class="bottom-nav" v-if="isMobile">
      <button
        v-for="tab in tabs"
        :key="tab.key"
        :class="['bottom-nav-btn', { active: currentTab === tab.key }]"
        @click="currentTab = tab.key"
      >
        <span class="tab-icon">{{ tab.icon }}</span>
        <small>{{ tab.label }}</small>
      </button>
    </nav>

    <!-- Toast 容器 -->
    <div class="toast-container">
      <div
        v-for="toast in toasts"
        :key="toast.id"
        class="toast"
        :class="'toast-' + toast.type"
      >{{ toast.message }}</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
