<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HiPrint Agent - 管理面板</title>
  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body>
  <div id="app">
    <!-- 侧边栏（Desktop） -->
    <aside class="sidebar" v-if="!isMobile">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 6 2 18 2 18 9"></polyline>
              <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
              <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
          </div>
          <div class="sidebar-logo-text">
            <h3>HiPrint Agent</h3>
            <small>管理面板</small>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <button
          v-for="tab in tabs"
          :key="tab.key"
          :class="['sidebar-btn', { active: currentTab === tab.key }]"
          @click="currentTab = tab.key"
        >
          <span class="tab-icon" v-html="tab.icon"></span>
          <span>{{ tab.label }}</span>
        </button>
      </nav>
      <div class="sidebar-footer">
        <span class="connection-dot" :class="socketConnected ? 'online' : 'offline'"></span>
        <small>{{ socketConnected ? '已连接' : '未连接' }}</small>
      </div>
    </aside>

    <!-- 主内容区 -->
    <main class="main-content" :class="{ 'with-sidebar': !isMobile }">
      <!-- 顶部标题栏（Mobile） -->
      <header class="mobile-header" v-if="isMobile">
        <h4>HiPrint Agent</h4>
        <span class="connection-dot" :class="socketConnected ? 'online' : 'offline'"></span>
      </header>

      <!-- Dashboard 视图 -->
      <section v-if="currentTab === 'dashboard'" class="view-section">
        <h4 class="view-title">仪表盘</h4>
        <div class="stats-grid">
          <!-- CPU 卡片 -->
          <article class="stat-card">
            <div class="stat-card-header">
              <span class="stat-icon">CPU</span>
            </div>
            <div class="stat-body">
              <p class="stat-value stat-value-animated">{{ systemStats.system?.cpuCount || 0 }} 核</p>
              <p class="stat-label">{{ systemStats.system?.cpuModel || '未知' }}</p>
            </div>
          </article>

          <!-- 内存卡片（环形进度） -->
          <article class="stat-card">
            <div class="stat-card-header">
              <span class="stat-icon">内存</span>
            </div>
            <div class="stat-body">
              <p class="stat-value stat-value-animated">{{ formatBytes(systemStats.system?.freeMem) }} 可用</p>
              <p class="stat-label">共 {{ formatBytes(systemStats.system?.totalMem) }}</p>
              <div class="mem-ring-wrap">
                <div class="mem-ring">
                  <svg viewBox="0 0 36 36">
                    <circle class="mem-ring-bg" cx="18" cy="18" r="16"></circle>
                    <circle
                      class="mem-ring-fill"
                      :class="memUsageClass"
                      cx="18" cy="18" r="16"
                      :stroke-dasharray="100.53"
                      :stroke-dashoffset="100.53 - (100.53 * memUsagePercent / 100)"
                    ></circle>
                  </svg>
                  <span class="mem-ring-text">{{ memUsagePercent }}%</span>
                </div>
                <div class="mem-ring-detail">
                  <small class="text-muted">已使用 {{ memUsagePercent }}%</small>
                  <small class="text-muted">{{ formatBytes(systemStats.system?.totalMem - systemStats.system?.freeMem) }} / {{ formatBytes(systemStats.system?.totalMem) }}</small>
                </div>
              </div>
            </div>
          </article>

          <!-- 活跃任务卡片 -->
          <article class="stat-card">
            <div class="stat-card-header">
              <span class="stat-icon">任务</span>
            </div>
            <div class="stat-body">
              <p class="stat-value stat-value-animated">{{ activeJobCount }}</p>
              <p class="stat-label">活跃任务</p>
              <div class="stat-detail">
                <span class="badge badge-rendering">渲染中 {{ systemStats.jobs?.rendering || 0 }}</span>
                <span class="badge badge-printing">打印中 {{ systemStats.jobs?.printing || 0 }}</span>
              </div>
            </div>
          </article>

          <!-- 运行时间卡片 -->
          <article class="stat-card">
            <div class="stat-card-header">
              <span class="stat-icon">运行</span>
            </div>
            <div class="stat-body">
              <p class="stat-value stat-value-animated">{{ formatUptime(systemStats.system?.uptime) }}</p>
              <p class="stat-label">运行时间</p>
              <div class="stat-detail">
                <small class="text-muted">{{ systemStats.system?.hostname || '--' }}</small>
              </div>
            </div>
          </article>

          <!-- 设备编号卡片 -->
          <article class="stat-card">
            <div class="stat-card-header">
              <span class="stat-icon">设备</span>
            </div>
            <div class="stat-body">
              <p class="stat-value stat-value-id" :title="systemStats.system?.machineId || ''">{{ systemStats.system?.machineId ? systemStats.system.machineId.substring(0, 12) + '...' : '未获取' }}</p>
              <p class="stat-label">设备编号</p>
              <div class="stat-detail">
                <button class="btn-sm btn-copy" v-if="systemStats.system?.machineId" @click="copyMachineId">复制</button>
              </div>
            </div>
          </article>
        </div>

        <!-- 任务统计概览 -->
        <h5 class="section-subtitle">任务统计</h5>
        <div class="stats-grid">
          <article class="stat-card mini">
            <div class="stat-body">
              <p class="stat-value stat-value-animated">{{ systemStats.jobs?.received || 0 }}</p>
              <p class="stat-label">已接收</p>
            </div>
          </article>
          <article class="stat-card mini">
            <div class="stat-body">
              <p class="stat-value stat-value-animated text-green">{{ systemStats.jobs?.done || 0 }}</p>
              <p class="stat-label">已完成</p>
            </div>
          </article>
          <article class="stat-card mini">
            <div class="stat-body">
              <p class="stat-value stat-value-animated text-red">{{ systemStats.jobs?.failed || 0 }}</p>
              <p class="stat-label">失败</p>
            </div>
          </article>
          <article class="stat-card mini">
            <div class="stat-body">
              <p class="stat-value stat-value-animated">{{ systemStats.connections || 0 }}</p>
              <p class="stat-label">连接数</p>
            </div>
          </article>
        </div>
      </section>

      <!-- Printers 视图 -->
      <section v-if="currentTab === 'printers'" class="view-section">
        <div class="view-title-bar">
          <h4 class="view-title" style="margin-bottom:0">打印机</h4>
          <button class="btn-sm btn-primary" @click="openAddPrinter">+ 添加打印机</button>
        </div>
        <div class="printer-grid" v-if="printers.length > 0">
          <article
            v-for="p in printers"
            :key="p.name"
            class="printer-card"
            :class="{ 'printer-offline': p.status > 0 }"
          >
            <div class="printer-status-dot" :class="printerStatusClass(p.status)"></div>
            <div class="printer-info">
              <div class="printer-name">{{ p.displayName || p.name }}</div>
              <div class="printer-desc">{{ p.description || '无描述' }}</div>
            </div>
            <div class="printer-badges">
              <span v-if="p.isDefault" class="badge badge-default">默认</span>
              <span class="badge" :class="printerBadgeClass(p.status)">{{ printerStatusText(p.status) }}</span>
            </div>
            <div class="printer-actions">
              <button class="btn-sm btn-ghost" @click="openEditPrinter(p)" title="编辑">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
              </button>
              <button v-if="!p.isDefault" class="btn-sm btn-ghost" @click="setDefaultPrinter(p.name)" title="设为默认">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
              </button>
              <button v-if="p.status > 0" class="btn-sm btn-ghost text-green" @click="enablePrinter(p.name)" title="启用">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
              </button>
              <button v-if="p.status === 0" class="btn-sm btn-ghost text-muted" @click="disablePrinter(p.name)" title="停用">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
              </button>
              <button class="btn-sm btn-ghost text-red" @click="confirmDeletePrinter(p.name)" title="删除">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
              </button>
            </div>
          </article>
        </div>
        <p v-else class="empty-state">暂未检测到打印机</p>
      </section>

      <!-- 打印机添加/编辑模态框 -->
      <div class="modal-overlay" v-if="showPrinterModal" @click.self="closePrinterModal" @keydown.esc="closePrinterModal">
        <div class="modal" @keydown.esc="closePrinterModal" tabindex="-1" ref="printerModalRef">
          <div class="modal-header">
            <h5>{{ printerModalMode === 'add' ? '添加打印机' : '编辑打印机' }}</h5>
            <button class="modal-close" @click="closePrinterModal">&times;</button>
          </div>
          <div class="modal-body">
            <div v-if="printerFormErrors.general" class="form-error-msg">{{ printerFormErrors.general }}</div>

            <div class="form-group" v-if="printerModalMode === 'add'">
              <label class="form-label">名称 <span class="text-red">*</span></label>
              <input class="form-input" v-model="printerForm.name" placeholder="例如 HP_LaserJet" :class="{ 'form-input-error': printerFormErrors.name }">
              <small v-if="printerFormErrors.name" class="form-error">{{ printerFormErrors.name }}</small>
            </div>
            <div class="form-group" v-else>
              <label class="form-label">名称</label>
              <input class="form-input" :value="printerForm.name" disabled>
            </div>

            <div class="form-group">
              <label class="form-label">设备 URI {{ printerModalMode === 'add' ? '*' : '' }}</label>
              <input class="form-input" v-model="printerForm.deviceUri" placeholder="例如 ipp://192.168.1.100/ipp/print" :class="{ 'form-input-error': printerFormErrors.deviceUri }">
              <small v-if="printerFormErrors.deviceUri" class="form-error">{{ printerFormErrors.deviceUri }}</small>
            </div>

            <div class="form-group" v-if="printerModalMode === 'add'">
              <label class="form-label">驱动模型</label>
              <input class="form-input" v-model="printerForm.model" placeholder="默认 everywhere (IPP Everywhere)">
            </div>

            <div class="form-group">
              <label class="form-label">描述</label>
              <input class="form-input" v-model="printerForm.description" placeholder="打印机描述信息">
            </div>

            <div class="form-group">
              <label class="form-label">位置</label>
              <input class="form-input" v-model="printerForm.location" placeholder="例如 三楼东侧">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-sm btn-ghost" @click="closePrinterModal">取消</button>
            <button class="btn-sm btn-primary" @click="submitPrinterForm" :disabled="printerSubmitting">
              {{ printerSubmitting ? '提交中...' : (printerModalMode === 'add' ? '添加' : '保存') }}
            </button>
          </div>
        </div>
      </div>

      <!-- 通用确认对话框 -->
      <div class="modal-overlay" v-if="confirmDialog.visible" @click.self="dismissConfirmDialog">
        <div class="modal modal-sm confirm-dialog" @keydown.esc="dismissConfirmDialog" tabindex="-1">
          <div class="modal-header">
            <h5>{{ confirmDialog.title }}</h5>
            <button class="modal-close" @click="dismissConfirmDialog">&times;</button>
          </div>
          <div class="modal-body">
            <p>{{ confirmDialog.message }}</p>
          </div>
          <div class="modal-footer">
            <button class="btn-sm btn-ghost" @click="dismissConfirmDialog">取消</button>
            <button class="btn-sm btn-danger" @click="confirmDialog.onConfirm">确认</button>
          </div>
        </div>
      </div>

      <!-- Jobs 视图 -->
      <section v-if="currentTab === 'jobs'" class="view-section">
        <h4 class="view-title">任务列表</h4>

        <!-- 状态过滤 -->
        <div class="job-filters">
          <button
            v-for="f in jobFilters"
            :key="f.value"
            :class="['filter-btn', { active: jobFilter === f.value }]"
            @click="jobFilter = f.value; loadJobs()"
          >{{ f.label }}</button>
        </div>

        <!-- Desktop 表格 -->
        <div class="job-table-wrap" v-if="!isMobile && jobs.length > 0">
          <table class="job-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>模板</th>
                <th>打印机</th>
                <th>状态</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="job in jobs" :key="job.id">
                <td><code>{{ shortId(job.id) }}</code></td>
                <td>{{ job.templateId || '--' }}</td>
                <td>{{ job.printer || '--' }}</td>
                <td><span class="badge" :class="jobBadgeClass(job.status)">{{ jobStatusText(job.status) }}</span></td>
                <td>{{ formatTime(job.createdAt) }}</td>
                <td class="job-actions">
                  <button
                    class="btn-sm btn-outline"
                    @click="openPreview(job.id)"
                    title="预览"
                  >预览</button>
                  <button
                    v-if="canCancel(job.status)"
                    class="btn-sm btn-cancel"
                    @click="cancelJob(job.id)"
                  >取消</button>
                  <button
                    v-if="canRetry(job.status)"
                    class="btn-sm btn-retry"
                    @click="retryJob(job.id)"
                  >重试</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Mobile 卡片列表 -->
        <div class="job-card-list" v-if="isMobile && jobs.length > 0">
          <article v-for="job in jobs" :key="job.id" class="job-card">
            <div class="job-card-head">
              <code>{{ shortId(job.id) }}</code>
              <span class="badge" :class="jobBadgeClass(job.status)">{{ jobStatusText(job.status) }}</span>
            </div>
            <div class="job-card-body">
              <p><small class="text-muted">模板：</small>{{ job.templateId || '--' }}</p>
              <p><small class="text-muted">打印机：</small>{{ job.printer || '--' }}</p>
              <p><small class="text-muted">时间：</small>{{ formatTime(job.createdAt) }}</p>
            </div>
            <div class="job-card-actions">
              <button
                class="btn-sm btn-outline"
                @click="openPreview(job.id)"
              >预览</button>
              <button
                v-if="canCancel(job.status)"
                class="btn-sm btn-cancel"
                @click="cancelJob(job.id)"
              >取消</button>
              <button
                v-if="canRetry(job.status)"
                class="btn-sm btn-retry"
                @click="retryJob(job.id)"
              >重试</button>
            </div>
          </article>
        </div>

        <p v-if="jobs.length === 0" class="empty-state">暂无任务记录</p>

        <!-- 加载更多 -->
        <div class="load-more" v-if="jobs.length > 0 && hasMoreJobs">
          <button class="btn-sm btn-load-more" @click="loadMoreJobs">加载更多</button>
        </div>
      </section>

      <!-- Maintenance 维护视图 -->
      <section v-if="currentTab === 'maintenance'" class="view-section">
        <h4 class="view-title">维护工具</h4>

        <!-- 快捷操作 -->
        <h5 class="section-subtitle">快捷操作</h5>
        <div class="maint-actions-grid">
          <div class="maint-action-card">
            <div class="maint-action-info">
              <div class="maint-action-title">一键诊断</div>
              <div class="maint-action-desc">检查 CUPS 服务、打印机状态、磁盘空间和任务队列</div>
            </div>
            <button class="btn-sm btn-primary" @click="runDiagnostics" :disabled="diagnosing">
              {{ diagnosing ? '诊断中...' : '运行诊断' }}
            </button>
          </div>
          <div class="maint-action-card">
            <div class="maint-action-info">
              <div class="maint-action-title">连通性检测</div>
              <div class="maint-action-desc">逐台检测所有打印机是否可达</div>
            </div>
            <button class="btn-sm btn-outline" @click="checkConnectivity" :disabled="checkingConnectivity">
              {{ checkingConnectivity ? '检测中...' : '开始检测' }}
            </button>
          </div>
          <div class="maint-action-card">
            <div class="maint-action-info">
              <div class="maint-action-title">清空所有队列</div>
              <div class="maint-action-desc">取消 CUPS 和内部队列中的所有待处理任务</div>
            </div>
            <button class="btn-sm btn-cancel" @click="confirmMaintenanceAction('clearQueues', '清空所有队列')">清空队列</button>
          </div>
          <div class="maint-action-card">
            <div class="maint-action-info">
              <div class="maint-action-title">重启 CUPS 服务</div>
              <div class="maint-action-desc">通过 systemctl 或 service 命令重启 CUPS 打印服务</div>
            </div>
            <button class="btn-sm btn-cancel" @click="confirmMaintenanceAction('restartCups', '重启 CUPS 服务')">重启 CUPS</button>
          </div>
        </div>

        <!-- 诊断结果 -->
        <template v-if="diagnosticResult">
          <h5 class="section-subtitle">诊断结果 <small class="text-muted">{{ formatTime(diagnosticResult.timestamp) }}</small></h5>
          <div class="diag-list">
            <div v-for="check in diagnosticResult.checks" :key="check.name" class="diag-item" :class="diagStatusClass(check.status)">
              <span class="diag-icon">{{ diagStatusIcon(check.status) }}</span>
              <div class="diag-info">
                <div class="diag-name">{{ check.name }}</div>
                <div class="diag-detail">{{ check.detail }}</div>
              </div>
            </div>
          </div>
        </template>

        <!-- 连通性检测结果 -->
        <template v-if="connectivityResult">
          <h5 class="section-subtitle">连通性检测结果</h5>
          <div class="diag-list">
            <div v-for="p in connectivityResult" :key="p.name" class="diag-item" :class="p.reachable ? 'diag-ok' : 'diag-error'">
              <span class="diag-icon">{{ p.reachable ? 'OK' : 'ERR' }}</span>
              <div class="diag-info">
                <div class="diag-name">{{ p.name }}</div>
                <div class="diag-detail">状态: {{ p.status }}</div>
              </div>
            </div>
          </div>
          <p v-if="connectivityResult.length === 0" class="empty-state" style="padding:32px 0">未检测到打印机</p>
        </template>

        <!-- CUPS 状态 -->
        <template v-if="cupsStatus">
          <h5 class="section-subtitle">CUPS 服务状态</h5>
          <div class="diag-list">
            <div class="diag-item" :class="cupsStatus.active ? 'diag-ok' : 'diag-error'">
              <span class="diag-icon">{{ cupsStatus.active ? 'OK' : 'ERR' }}</span>
              <div class="diag-info">
                <div class="diag-name">CUPS 服务</div>
                <div class="diag-detail">{{ cupsStatus.detail }}</div>
              </div>
            </div>
          </div>
        </template>

        <!-- CUPS 错误日志 -->
        <h5 class="section-subtitle">
          CUPS 错误日志
          <button class="btn-sm btn-ghost" style="margin-left:8px" @click="loadCupsLogs" :disabled="loadingCupsLogs">
            {{ loadingCupsLogs ? '加载中...' : '加载日志' }}
          </button>
        </h5>
        <pre v-if="cupsLogs" class="cups-log-pre">{{ cupsLogs }}</pre>
        <p v-else class="empty-state" style="padding:32px 0">点击"加载日志"查看 CUPS 错误日志</p>
      </section>

      <!-- Logs 视图 -->
      <section v-if="currentTab === 'logs'" class="view-section">
        <h4 class="view-title">日志记录</h4>
        <div class="log-list" v-if="logEntries.length > 0">
          <div v-for="(entry, idx) in logEntries" :key="idx" class="log-entry">
            <span class="log-time">{{ formatTime(entry.time) }}</span>
            <span class="badge badge-sm" :class="jobBadgeClass(entry.status)">{{ jobStatusText(entry.status) }}</span>
            <span class="log-detail">
              任务 <code>{{ shortId(entry.id) }}</code>
              <template v-if="entry.printer"> - {{ entry.printer }}</template>
            </span>
          </div>
        </div>
        <p v-else class="empty-state">暂无日志</p>
      </section>

      <!-- 底部留白（Mobile 为底部导航栏腾出空间） -->
      <div class="bottom-spacer" v-if="isMobile"></div>
    </main>

    <!-- 底部导航（Mobile） -->
    <nav class="bottom-nav" v-if="isMobile">
      <button
        v-for="tab in tabs"
        :key="tab.key"
        :class="['bottom-nav-btn', { active: currentTab === tab.key }]"
        @click="currentTab = tab.key"
      >
        <span class="tab-icon" v-html="tab.icon"></span>
        <small>{{ tab.label }}</small>
      </button>
    </nav>

    <!-- 任务预览模态框 -->
    <div class="modal-overlay" v-if="showPreviewModal" @click.self="closePreview">
      <div class="modal modal-preview" @keydown.esc="closePreview" tabindex="-1">
        <div class="modal-header">
          <h5>任务内容预览</h5>
          <button class="modal-close" @click="closePreview">&times;</button>
        </div>
        <div class="modal-body preview-body">
          <div v-if="previewLoading" class="preview-loading">加载中...</div>
          <div v-if="previewError" class="preview-error">{{ previewError }}</div>
          <iframe
            v-if="previewUrl && !previewError"
            :src="previewUrl"
            class="preview-iframe"
            sandbox="allow-same-origin"
            @load="onPreviewLoad"
            @error="onPreviewError"
          ></iframe>
        </div>
      </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container">
      <div
        v-for="toast in toasts"
        :key="toast.id"
        class="toast"
        :class="'toast-' + toast.type"
      >{{ toast.message }}</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
